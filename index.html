<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
    <title>v2ray-docker</title>
    <meta property="og:title" content="Welcome to GitHub Pages">
    <meta property="og:locale" content="en_US">
    <meta name="description" content="v2ray deploy by docker">
    <meta property="og:description" content="v2ray deploy by docker">
    <link rel="canonical" href="https://alanhg.github.io/v2ray-docker/">
    <meta property="og:url" content="https://alanhg.github.io/v2ray-docker/">
    <meta property="og:site_name" content="v2ray-docker">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary">
    <meta property="twitter:title" content="Welcome to GitHub Pages">
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700&amp;display=swap" as="style"
          type="text/css" crossorigin="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#157878">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="stylesheet" href="./style.css?v=e4efdad7226cfcfaeed3371995a7a4e58293be7d">
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

    <!-- Setup Google Analytics -->


    <!-- You can set your favicon here -->
    <!-- link rel="shortcut icon" type="image/x-icon" href="/v2ray-docker/favicon.ico" -->

    <!-- end custom head snippets -->

    <script src="./jszip.min.js"></script>
    <script src="./uuid.min.js"></script>
    <script src="./clipboard.min.js"></script>

</head>
<body data-new-gr-c-s-check-loaded="14.1062.0" data-gr-ext-installed="">
<a id="skip-to-content" href="#content">Skip to the content.</a>

<header class="page-header" role="banner">
    <h1 class="project-name">v2ray-docker</h1>
    <h2 class="project-tagline">fill form and download</h2>
</header>

<main id="content" class="main-content" role="main">
    <h2 id="welcome-to-github-pages">1Ô∏è‚É£ Generate Config</h2>
    <form id="configForm">
        <label for="domainName">
            <div class="required">
                Domain Name
            </div>
            <input id="domainName" type="text" required/>
        </label>
        <label for="email">
            <div class="required">
                Email
            </div>
            <input id="email" type="text" required/>
        </label>
        <label for="clientId">
            <div class="required">
                ClientId
            </div>
            <input id="clientId" type="text"/>
            <a onclick="regenerateClientId()">(Randomly generate)</a>
        </label>
        <label for="wsPath">
            <div class="required">
                wsPath
            </div>
            <input id="wsPath" type="text" value="/helloworld" required/>
        </label>
    </form>
    <button onclick="formSubmit()">
        Download Config
    </button>

    <h2>2Ô∏è‚É£ Deploy</h2>

    Notice: `CentOS 7 x64`, Don't use CentOS 8

    <ol>
        <li>
            add dns record VPS ip on site
        </li>
        <li>
            upload config to VPS
        </li>
        <li>
            execute the following command
            <pre><code>chmod +x ./*.sh
./init-v2ray.sh
# Pay attention to time zone
timedatectl set-timezone Asia/Shanghai

# Speed Test
# abroad
wget -qO- bench.sh | bash

# home
wget -qO- git.io/superbench.sh | bash</code></pre>

        </li>
    </ol>
    <h2>3Ô∏è‚É£ Client Config</h2>
    <h3>
        Surge
    </h3>
    <textarea rows="3" id="surgeConfig">
    </textarea>
    <button data-clipboard-target="#surgeConfig" class="copy-btn">
        Copy to Clipboard
    </button>
    <h3>
        Clash
    </h3>
    <textarea rows="15" id="clashConfig">

    </textarea>
    <button data-clipboard-target="#clashConfig" class="copy-btn">
        Copy to Clipboard
    </button>
    <h2>4Ô∏è‚É£ Just enjoy üöÄ</h2>
    <footer class="site-footer">

        <span class="site-footer-owner"><a href="https://github.com/alanhg/v2ray-docker">v2ray-docker</a> is maintained by <a
                href="https://github.com/alanhg">alanhg</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a>.</span>
    </footer>
</main>

<template id="surgeConfigTpl">
    <textarea rows="3">
[Proxy]
proxy1 = vmess, __DomainName__, 443, username=__ClientId__, ws=true, ws-path=__WsPath__, tls=true
    </textarea>
</template>
<template id="clashConfigTpl">
  <textarea rows="15">
      proxies:
        -
          name: proxy1
          type: vmess
          server: __DomainName__
          port: 443
          uuid: __ClientId__
          alterId: 64
          cipher: auto
          tls: true
          skip-cert-verify: false
          servername: __DomainName__
          network: ws
          ws-opts:
            path: __WsPath__
    </textarea>
</template>
<script>
  regenerateClientId();
  generateClientConfig();
  new ClipboardJS('.copy-btn');

  function regenerateClientId() {
    document.getElementById('clientId').value = uuid.v4();
  }

  function saveAs(blob, filename) {
    const url = URL.createObjectURL(blob);
    const linkEl = document.createElement('a');
    linkEl.href = url;
    linkEl.download = filename;
    linkEl.click();
  }

  async function formSubmit() {
    const domainName = document.getElementById('domainName').value;
    const email = document.getElementById('email').value;
    const clientId = document.getElementById('clientId').value;
    const wsPath = document.getElementById('wsPath').value;

    if (!domainName || !email || !clientId || !wsPath) {
      alert('All config-field is required!');
      return;
    }

    let [initV2RayFile, initLetsEncryptFile, initDockerComposeFile, v2RayConfigFile, nginxConfigFile] = await Promise.all([
      fetch('./v2ray_config/init-v2ray.sh').then(res => res.text()),
      fetch('./v2ray_config/init-letsencrypt.sh').then(res => res.text()),
      fetch('./v2ray_config/docker-compose.yml').then(res => res.text()),
      fetch('./v2ray_config/v2ray/config.json').then(res => res.text()),
      fetch('./v2ray_config/nginx/conf.d/default.conf').then(res => res.text())
    ])
    const zip = new JSZip();
    const replacePattern = [
      {
        key: '__DomainName__',
        value: domainName
      },
      {
        key: '__Email__',
        value: email
      },
      {
        key: '__ClientId__',
        value: clientId
      }, {
        key: '__WsPath__',
        value: wsPath
      },
    ];

    /**
     * replace template config
     */
    initV2RayFile = replaceConfig(initV2RayFile, replacePattern);
    initLetsEncryptFile = replaceConfig(initLetsEncryptFile, replacePattern);
    v2RayConfigFile = replaceConfig(v2RayConfigFile, replacePattern);
    nginxConfigFile = replaceConfig(nginxConfigFile, replacePattern);

    zip.file('v2ray-docker/init-v2ray.sh', initV2RayFile);
    zip.file('v2ray-docker/init-letsencrypt.sh', initLetsEncryptFile);
    zip.file('v2ray-docker/docker-compose.yml', initDockerComposeFile);
    zip.file('v2ray-docker/v2ray/config.json', v2RayConfigFile);
    zip.file('v2ray-docker/nginx/conf.d/default.conf', nginxConfigFile);

    zip.generateAsync({type: 'blob'}).then(function (content) {
      saveAs(content, 'v2ray-docker.zip');
      generateClientConfig(replacePattern);
    });
  }


  function replaceConfig(cnt, replacePattern) {
    return replacePattern.reduce((res, item) => res.replaceAll(item.key, item.value), cnt);
  }

  function generateClientConfig(replacePattern = []) {
    const surgeConfigEl = document.getElementById('surgeConfig');
    const clashConfigEl = document.getElementById('clashConfig');

    const surgeConfigTplEl = document.getElementById('surgeConfigTpl').content.querySelector('textarea');
    const clashConfigTplEl = document.getElementById('clashConfigTpl').content.querySelector('textarea');
    if (replacePattern.length) {
      surgeConfigEl.value = replaceConfig(surgeConfigTplEl.value, replacePattern);
      clashConfigEl.value = replaceConfig(clashConfigTplEl.value, replacePattern);
    } else {
      surgeConfigEl.value = surgeConfigTplEl.value;
      clashConfigEl.value = clashConfigTplEl.value;
    }

  }

</script>
</body>
</html>